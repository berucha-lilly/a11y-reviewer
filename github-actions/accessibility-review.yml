name: Accessibility Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: false
        type: string
      repository:
        description: 'Repository (owner/repo)'
        required: false
        type: string
      branch:
        description: 'Branch to analyze'
        required: false
        type: string
        default: 'main'

jobs:
  accessibility-check:
    name: üîç Accessibility Review
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diff analysis
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üîß Install dependencies
        working-directory: .github/a11y-reviewer
        run: npm install --omit=dev

      - name: üìÅ Check for configuration
        id: config-check
        run: |
          if [ -f ".a11y/config.json" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found .a11y/config.json"
            cat .a11y/config.json
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No .a11y/config.json found. Using default configuration."
          fi

      - name: üîß Setup A11y Configuration
        if: steps.config-check.outputs.config_exists == 'false'
        run: |
          echo "üìù Creating default accessibility configuration..."
          mkdir -p .a11y
          cat > .a11y/config.json << 'EOF'
          {
            "$schema": "https://a11y-reviewer.internal/schema/v1",
            "wcagLevel": "AA",
            "wcagVersion": "2.2",
            "strictMode": true,
            "rules": {
              "aria-required": {
                "enabled": true,
                "severity": "error"
              },
              "keyboard-nav": {
                "enabled": true,
                "severity": "error"
              },
              "semantic-html": {
                "enabled": true,
                "severity": "error"
              },
              "alt-text": {
                "enabled": true,
                "severity": "error"
              }
            },
            "failureThresholds": {
              "error": 0,
              "warning": 10
            },
            "ignore": [
              "**/*.test.{js,jsx,ts,tsx}",
              "**/*.stories.{js,jsx,ts,tsx}",
              "node_modules/**",
              "dist/**",
              "build/**",
              ".git/**"
            ]
          }
          EOF
          echo "‚úÖ Default configuration created"

      - name: üìä Get PR Information
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "repository=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "üìã PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          else
            echo "pr_number=${{ github.event.inputs.pr_number || 'manual' }}" >> $GITHUB_OUTPUT
            echo "repository=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.inputs.branch || 'main' }}" >> $GITHUB_OUTPUT
            echo "base_branch=main" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
            echo "üìä Manual analysis for ${{ github.event.inputs.branch || 'main' }}"
          fi

      - name: üîç Run Accessibility Analysis via MCP
        id: a11y-analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          REPOSITORY: ${{ steps.pr-info.outputs.repository }}
          BRANCH: ${{ steps.pr-info.outputs.branch }}
        run: |
          echo "üìä Running PR analysis with hybrid analyzer..."
          node .github/a11y-reviewer/analyze-pr-mcp.js
          
          # Check results
          if [ -f ".github/a11y-reviewer/a11y-results.json" ]; then
            echo "‚úÖ Analysis completed successfully"
            VIOLATIONS=$(cat .github/a11y-reviewer/a11y-results.json | jq -r '.summary.totalViolations // 0')
            ERRORS=$(cat .github/a11y-reviewer/a11y-results.json | jq -r '.summary.errors // 0')
            WARNINGS=$(cat .github/a11y-reviewer/a11y-results.json | jq -r '.summary.warnings // 0')
            ANALYZED=$(cat .github/a11y-reviewer/a11y-results.json | jq -r '.analyzedFiles // 0')
            
            echo "üìä Results: $VIOLATIONS total violations ($ERRORS errors, $WARNINGS warnings)"
            echo "üìÅ Files analyzed: $ANALYZED"
            
            # Set output for next steps
            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
            echo "analyzedFiles=$ANALYZED" >> $GITHUB_OUTPUT
            
            if [ "$ERRORS" -gt 0 ]; then
              echo "‚ùå Found $ERRORS critical errors - build will fail"
              echo "has_errors=true" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ No critical errors found"
              echo "has_errors=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Analysis failed - no results file generated"
            echo "‚ö†Ô∏è  This might indicate an MCP server communication issue"
            echo "violations=0" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "warnings=0" >> $GITHUB_OUTPUT
            echo "analyzedFiles=0" >> $GITHUB_OUTPUT
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: üìã Post PR Comment
        if: always() && steps.a11y-analysis.outputs.violations != null
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read analysis results
            if (!fs.existsSync('.github/a11y-reviewer/a11y-results.json')) {
              console.log('‚ö†Ô∏è  No results file found. Skipping comment.');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync('.github/a11y-reviewer/a11y-results.json', 'utf8'));
            
            // Create comment body
            let comment = `## üîç Accessibility Reviewer Results \n\n`;
            comment += `**Powered by:** Model Context Protocol (MCP) Server\n`;
            comment += `**Files Checked:** ${results.analyzedFiles}\n`;
            comment += `**Files with Violations:** ${results.filesWithViolations}\n`;
            comment += `**Total Violations:** ${results.summary.totalViolations} (${results.summary.errors} errors, ${results.summary.warnings} warnings)\n\n`;
            
            if (results.summary.totalViolations === 0) {
              comment += `‚úÖ **No accessibility violations found!**\n\n`;
              comment += `- **Files Analyzed**: ${results.analyzedFiles}\n`;
              comment += `- **Status**: All checks passed\n\n`;
              comment += `This PR meets WCAG 2.2 AA accessibility standards. üéâ\n\n`;
            } else {
              comment += `**Found ${results.summary.totalViolations} accessibility violation(s):**\n\n`;
              
              // Group violations by file
              if (results.files && results.files.length > 0) {
                results.files.forEach(fileResult => {
                  if (fileResult.violations.length > 0) {
                    comment += `#### üìÑ \`${fileResult.filePath}\`\n\n`;
                    comment += `Found ${fileResult.violations.length} violation(s):\n\n`;
                    
                    fileResult.violations.forEach((v, index) => {
                      const severityLabel = v.severity === 'error' ? '[ERROR]' : '[WARNING]';
                      comment += `${index + 1}. **${severityLabel}** ${v.message}\n`;
                      if (v.line) {
                        comment += `   - **Line:** ${v.line}\n`;
                      }
                      if (v.description) {
                        comment += `   - **Issue:** ${v.description}\n`;
                      }
                      if (v.fix) {
                        comment += `   - **Fix:** ${v.fix}\n`;
                      }
                      if (v.wcagCriteria && v.wcagCriteria.length > 0) {
                        comment += `   - **WCAG:** ${v.wcagCriteria.join(', ')}\n`;
                      }
                      if (v.suggestions && v.suggestions.length > 0) {
                        comment += `   - **Suggestions:**\n`;
                        v.suggestions.forEach(suggestion => {
                          comment += `     - ${suggestion}\n`;
                        });
                      }
                      comment += `\n`;
                    });
                    
                    comment += `\n`;
                  }
                });
              }
              
              comment += `### üìä Summary by Severity\n\n`;
              if (results.summary.errors > 0) {
                comment += `- üî¥ **${results.summary.errors} Critical Error(s)** - Must fix before merging\n`;
              }
              if (results.summary.warnings > 0) {
                comment += `- üü° **${results.summary.warnings} Warning(s)** - Recommended to fix\n`;
              }
              comment += `\n`;
            }
            
            comment += `### üìö Resources\n\n`;
            comment += `- [WCAG 2.2 Guidelines](https://www.w3.org/WAI/WCAG22/quickref/)\n`;
            comment += `- [Model Context Protocol](https://modelcontextprotocol.io/)\n`;
            comment += `- [Accessibility Testing Tools](https://github.com/dequelabs/axe-core)\n\n`;
            
            comment += `---\n`;
            comment += `*Analysis performed by A11y-MCP Server*\n`;
            
            // Post comment to PR
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            console.log('‚úÖ Posted accessibility results to PR');

      - name: üéØ Success Summary
        if: steps.a11y-analysis.outputs.has_errors == 'false'
        run: |
          echo "‚úÖ Accessibility check completed successfully!"
          echo "üìä No critical errors found"
          echo "üîç Analyzed ${{ steps.a11y-analysis.outputs.analyzedFiles }} files"
          echo "‚ö†Ô∏è  ${{ steps.a11y-analysis.outputs.warnings }} warnings (non-blocking)"
          
          # Create summary artifact
          echo "## Accessibility Analysis Summary" > accessibility-summary.md
          echo "" >> accessibility-summary.md
          echo "**Status**: ‚úÖ Passed" >> accessibility-summary.md
          echo "**Files Analyzed**: ${{ steps.a11y-analysis.outputs.analyzedFiles }}" >> accessibility-summary.md
          echo "**Violations Found**: ${{ steps.a11y-analysis.outputs.violations }}" >> accessibility-summary.md
          echo "**Critical Errors**: ${{ steps.a11y-analysis.outputs.errors }}" >> accessibility-summary.md
          echo "**Warnings**: ${{ steps.a11y-analysis.outputs.warnings }}" >> accessibility-summary.md
          echo "" >> accessibility-summary.md
          echo "This PR meets WCAG 2.2 AA accessibility standards." >> accessibility-summary.md

      - name: üì¶ Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-analysis-results
          path: |
            .github/a11y-mcp/a11y-results.json
            accessibility-summary.md
          retention-days: 30

      - name: ‚ùå Fail on Critical Errors
        if: steps.a11y-analysis.outputs.has_errors == 'true'
        run: |
          echo "‚ùå Accessibility check failed due to ${{ steps.a11y-analysis.outputs.errors }} critical error(s)"
          echo "üîß Please fix the critical accessibility violations before merging"
          echo ""
          echo "Errors found:"
          cat .github/a11y-mcp/a11y-results.json | jq -r '.files[]?.violations[]? | select(.severity == "error") | "- \(.id) in \(.message)"'
          exit 1
